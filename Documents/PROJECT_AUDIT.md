# Project Audit (Stability-Focused)

## Scope
- Оценка стабильности и надежности бота (C++ `VirtApp`, скрипты, пайплайн сборки).
- Безопасность не рассматривается по запросу.

## Текущее состояние
- **Кодовая база:** C++17 с плотным procedural flow в `src/main.cpp` (единственный большой файл ~4.7k строк).
- **Сборка:** MSBuild через CMake генерацию (`build_final/VirtApp.sln`) — сборка Release проходит, но с ~34 предупреждениями.
- **Артефакт:** `Release_Prod/VirtApp.exe` обновлён (master DGatman), safe-exit: крестик (1158,100) → F10 → ESC.
- **Скрипты:** Python для времени/гейма (в `scripts/`), не покрыты тестами.

## Ключевые наблюдения (стабильность)
- **Гигантский main.cpp:** сложная ветвистая логика без модульности → высокие риски регрессий, сложно тестировать и сопровождать.
- **Блокирующие Sleep:** частые фиксированные задержки (сотни точек) вместо событий/таймеров; при лаге/разном FPS возможны зависания или пропуски.
- **Ожидания по пикселям без верхних границ:** в ряде мест (пример: ожидание появления казино-приложения в телефоне) отсутствует или слишком большой upper bound → может крутить бесконечно, потребляя цикл.
- **Логика safe-exit:** сейчас по шагам: клик крестик (1158,100) → F10 → ESC. Нет проверки факта закрытия окна (только blind actions); при смене UI координат возможен залип.
- **Хардкоды координат и цветов:** всё завязано на фиксированные точки/цвета; изменение UI/разрешения легко ломает поток. Нет централизованного конфиг-файла для координат/палитр.
- **Повторные попытки открытия телефона:** цикл 10 раз с логом «Phone opened» даже при неоткрытом телефоне — лог вводит в заблуждение, состояние не проверяется между итерациями.
- **Логирование:** много логов, но нет уровней/структуры; поиск инцидентов затруднён. Ошибки/исключения почти не обрабатываются, кроме нескольких try/catch на Telegram.
- **Ввод/клавиши:** прямые отправки в драйвер без дебаунса и без проверки активного окна; риск «клавиши улетели» при фокусе на другом окне.
- **Сборка/артефакты:** предупреждения C4996/C4267/C4552/C4477/C4566 → потенциальные UB/потери данных/краши на разных локалях.
- **Отсутствие тестов:** нет unit/интеграционных тестов даже для утилитарных функций (OCR/парсинг/временные операции).

## Риски по стабильности
- **Race/залипы:** Бесконечные или длинные циклы ожидания UI могут вешать поток бота.
- **Дрейф координат:** любое смещение UI (другой DPI/оконный режим) ломает клики.
- **Локаль/кодировка:** предупреждения C4566/C4477 указывают на проблемы форматирования строк → краши при выводе.
- **Непредсказуемый ввод:** отправка ESC/F10/кликов без верификации состояния может открыть не то меню.
- **Тайминги:** фиксированные задержки без адаптации к FPS/нагрузке дают флейки (то слишком быстро, то слишком медленно).

## Рекомендации (приоритет)
1) **Разбивка main.cpp:** вынести модули (UI automation, timers, state machine, logging, config). Ввести явную state machine для сценариев (презенты, рулетка, логин).
2) **Централизовать координаты/цвета:** конфиг (JSON/INI) с профилями под разные режимы; в коде — загрузка и валидация.
3) **Ввести «жёсткие» таймауты и проверку состояния:** каждый цикл ожидания должен иметь max attempts + явный fail path с логом и переходом в safe state.
4) **Верификация закрытия меню:** после крестика/F10/ESC проверять пиксели, что меню реально закрыто; иначе — повтор/skip с логом.
5) **Переключить логирование на уровни:** info/warn/error + ключевые события. Добавить идентификаторы сессии для корреляции.
6) **Устранить build warnings (стабильность):**
   - заменить deprecated `getenv`, `localtime`, `strcpy` на безопасные аналоги (`_dupenv_s`, `localtime_s`, `strcpy_s`).
   - исправить C4244/C4267 (приведения типов), C4477 (printf формат), C4552 (неиспользуемый результат), C4566 (юникод в строках → убрать/экранировать).
7) **Дебаунс ввода:** перед отправкой клавиш проверять активное окно/фокус; добавить небольшие рандомные задержки для устойчивости.
8) **Автотесты (минимум):** покрыть утилиты (парсинг конфигов, простые вычисления), мокать OCR/ввод; хотя бы smoke-тест на запуск с dry-run.
9) **Мониторинг циклов:** добавить watchdog на «висим в ожидании X секунд» с авто-recover (перезапуск сценария без ребута машины).
10) **Документация потоков:** описать сценарии (login, presents, ruletka) пошагово, с условиями входа/выхода, таймаутами, чтобы снижать регрессии.

## Быстрые мелкие правки (можно сделать сразу)
- Проверка закрытия меню: после крестика/F10/ESC — условный `if (!scan.checkPixel(... закрыто ...)) retry/skip`.
- Исправить `printf("%s", someStdString)` → использовать `.c_str()`.
- Убрать «Phone opened» из цикла неуспешных попыток; логировать «Trying to open phone (attempt N)».
- Добавить upper bound в цикле ожидания открытия казино-приложения (там где `while (!scan.checkPixel(...))`).

## Следующие шаги для «high-end prod»
- Принять план refactor: state machine + конфиг координат + центральный ввод/логгер.
- Починить все warning’и и включить `/WX` на CI.
- Сделать smoke-test скрипт (PowerShell) для быстрой проверки запуска с моками.
- Добавить watchdog и детектор зависаний.

(Безопасность осознанно не анализировалась по запросу.)
